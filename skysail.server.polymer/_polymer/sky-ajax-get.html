<link rel="import" href="/_polymer/bower_components/polymer/polymer.html">
<link rel="import" href="/_polymer/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="sky-ajax-get">

 <style>
    .list-group-item {
      padding: 5px 15px;
    }
  </style>

  <template>
    <iron-ajax 
        id="ajax"
        handle-as="json" 
        headers='{"Accept": "application/json"}'
        on-response="hResponse"
        last-response="{{data}}"
        debounce-duration="300" />
    <div class="list-group">
      <template is="dom-repeat" items="{{data}}">
        <a ajaxhref="{{renderLink(linkTo, item, identifier)}}" on-click="handleClick" class$="{{itemClass(linkTo, item, identifier, requestUrl)}}" title="{{item.name}}">
          <span class="glyphicon glyphicon-file"></span>
          <span>{{shorten(item,nameProperty,linkLength)}}</span> </a>
      </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'sky-ajax-get',
      properties: {
    	  url: String,
    	  nameProperty: {
    		  type: String,
    		  value: "name"
    	  },
    	  identifier: {
    		  type: String,
    		  value: "id"
    	  },
    	  linkTo: String,
    	  requestUrl: String,
    	  linkLength: {
    		  type: Number,
    		  value: 10
    	  }
      },
      renderLink: function(href, item, identifier) {
       	  return href.replace("{" + identifier + "}", item.id);
      },
      shorten(str, nameProperty, maxLength) {
    	  if (str[nameProperty].length > maxLength) {
    		  return str[nameProperty].slice(0,maxLength-3) + "...";
    	  }
    	  return str[nameProperty];
      },
      itemClass: function(href, item, identifier, requestUrl) {
    	  if (requestUrl.startsWith(href.replace("{" + identifier + "}", item.id))) {
              return "list-group-item active";  
    	  } else {
              return "list-group-item";  
    	  }
      },
      attached: function() {
    	  this.$.ajax.url=this.url;
    	  this.$.ajax.generateRequest();
      },
      handleClick: function(e, f, g) {
    	  
    	  // http://www.quirksmode.org/js/events_properties.html
          if (!e) var e = window.event;
    		var srcElement = e.target;
    		
    	  var ajaxhref = srcElement.ajaxhref;
          var ajaxTable = document.getElementById("theAjaxContent");
          ajaxTable.url = ajaxhref;
          // ajaxTable.linkTo="/Todos/Lists/{lid}/Todos";
          // ajaxTable.identifier="lid";
          // ajaxTable.requestUrl="/Todos";
          ajaxTable.nameProperty="title";
          document.getElementById("ajaxTable").generateRequest();
      },
      hResponse: function(request) {
          console.log(request.detail);
      }
    });
  </script>

</dom-module>