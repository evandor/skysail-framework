<link rel="import" href="/_polymer/bower_components/polymer/polymer.html">
<link rel="import" href="/_polymer/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="sky-ajax-table1">

 <style>
    .list-group-item {
      padding: 5px 15px;
    }
  </style>

  <template>
    <iron-ajax
        id="ajaxTable" auto
        handle-as="json" 
        headers='{"Accept": "application/json"}'
        on-response="hResponse"
        last-response="{{data}}"
        debounce-duration="300" />
    <table class="table table-striped">
      <tr>
        <template is="dom-repeat" items="{{columnNames}}">
          <th>{{item}}</th>
        </template>
      </tr>
      <template is="dom-repeat" items="{{data}}" as="row">
      <tr>
        <template is="dom-repeat" items="{{_toArray(row,columnNames)}}" as="column">
          <td><sky-html html="{{column.value}}"></sky-html></td>
        </template>
      </tr>
      </template>
    </table>
  </template>

  <script>
    Polymer({
      is: 'sky-ajax-table1',
      properties: {
    	  url: {
    		  type: String,
    		  observer: '_urlChanged'
    	  },
    	  columnNames: {
    		  type: Array,
    		  value: ['please define the attribute column-names']
    	  },
    	  nameProperty: {
    		  type: String,
    		  value: "name",
    		  observer: '_namePropertyChanged'
    	  },
    	  identifier: {
    		  type: String,
    		  value: "id"
    	  },
    	  linkTo: String,
    	  requestUrl: String,
    	  linkLength: {
    		  type: Number,
    		  value: 10
    	  }
      },
      renderLink: function(href, item, identifier) {
       	  return href.replace("{" + identifier + "}", item.id);
      },
      shorten(str, nameProperty, maxLength) {
    	  console.log("name: " + nameProperty);
    	  if (str[nameProperty].length > maxLength) {
    		  return str[nameProperty].slice(0,maxLength-3) + "...";
    	  }
    	  return str[nameProperty];
      },
      itemClass: function(href, item, identifier, requestUrl) {
    	  if (requestUrl.startsWith(href.replace("{" + identifier + "}", item.id))) {
              return "list-group-item active";  
    	  } else {
              return "list-group-item";  
    	  }
      },
      attached: function() {
    	console.log(this.localName + '#' + this.id + ' was attached1');
     	this.$.ajaxTable.url=this.url;
    	//this.$.ajaxTable.generateRequest();
      },
      hResponse: function(request) {
          console.log(request.detail);
      },
      created: function() {
  	    //console.log(this.localName + '#' + this.id + ' was created');
  	  },
  	  detached: function() {
  	    console.log(this.localName + '#' + this.id + ' was detached');
  	  },
  	  attributeChanged: function(name, type) {
  	    console.log(this.localName + '#' + this.id + ' attribute ' + name +
  	      ' was changed to ' + this.getAttribute(name));
  	  },
  	  _urlChanged: function(newValue, oldValue) {
        this.$.ajaxTable.url=newValue;
        console.log("value url changed from " + oldValue + " to " + newValue);
  	  },
  	  _namePropertyChanged:function(newValue, oldValue) {
        this.$.ajaxTable.nameProperty=newValue;
        console.log("nameProperty changed from " + oldValue + " to " + newValue);
  	  },
  	  _toArray: function(obj, columnNames) {
        return columnNames.map(function(key) {
          return {name: key, value: obj[key]};
        });
      },
      _toArrayOrig: function(obj, columnNames) {
          return Object.keys(obj).map(function(key) {
            return {name: key, value: obj[key]};
          });
      },
      unescape: function(value) {
    	  this.innerHTML = "<a href='#'>heise</a>";
	    return value;
	  }
    });
  </script>

</dom-module>